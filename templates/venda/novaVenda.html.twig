{% extends "pagesApp.html.twig" %}
{% block title %}
    Nova venda
{% endblock %}
{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('styles/novaVenda.css') }}">
{% endblock %}
{% block content %}
    <main>
        <h2 class="text-white h2 p-2 mb-3">Nova Venda</h2>

        <!-- card -->
        <section>
            <div class="card-area">
                <div class="card-item">
                    <div class="card-top">
                        <span class="card-titulo">Total</span>
                        <div class="card-right">
                            <img src="{{ asset('images/simbolo-do-dolar.png') }}" alt="simbolo-do-dolar.png">
                        </div>
                    </div>
                    <div class="card-bottom">
                        <p class="resultado">R$1000,00</p>
                    </div>
                </div>
                <div class="card-item">
                    <div class="card-top">
                        <span class="card-titulo">Status</span>
                        <div class="card-right">
                            <img src="{{ asset('images/status.png') }}" alt="status.png">
                        </div>
                    </div>
                    <div class="card-bottom">
                        <p class="resultado">Pendente</p>
                    </div>
                </div>
                <div class="card-item">
                    <div class="card-top">
                        <span class="card-titulo">Data</span>
                        <div class="card-right">
                            <img src="{{ asset('images/calendario-de-parede-mensal.png') }}" alt="calendario-de-parede-mensal.png">
                        </div>
                    </div>
                    <div class="card-bottom">
                        <p class="resultado">22/01/2006</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="formulario">
            <form id="finalizarVendaForm" action="{{ path('finalizarCarrinho') }}" method="POST">
                <p class="texto">Cliente*</p>
                <div class="formulario-area">
                    <select class="form-select" id="cliente-Select" name="cliente" required>
                        <option value="">Selecione um cliente</option>
                    </select>
                    <button type="submit" class="Finalizar-button">
                        <strong>Finalizar venda</strong>
                    </button>
                </div>
            </form>
        </section>

        <section class="tabela">
            <table>
                <thead>
                    <tr class="tabela-topo">
                        <th scope="col">Nome</th>
                        <th scope="col">Categoria</th>
                        <th scope="col">Estoque</th>
                        <th scope="col">Quantidade</th>
                        <th scope="col">Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tabela">
                {#     <td> produto.nome </td>
							<td> produto.categoria.nome </td>
							<td> produto.estoque </td>
							<td class="quantidade">
								<input class="input-number" type="number" name="" value=" produto.quantidade " min="1">
							</td>
							<td>R$ produto.total </td>
							<td><img class="icone" src="{{ asset('images/lixo.png') }}" alt="Remover"></td> #}
                </tbody>
            </table>
        </section>
    </main>
{% endblock %}

{% block javascripts %}
        {{ parent() }}
        <script>
        async function carregarClientes() {
            try {
                const response = await fetch('/api/clientes', { 
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('Erro ao carregar clientes');
                const clientes = await response.json();

                const clienteSelect = document.getElementById('cliente-Select');
                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    clienteSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Carregar clientes ao inicializar a página
        

        document.addEventListener('DOMContentLoaded', function() {
            carregarClientes();

            const clienteSelect = document.getElementById('cliente-Select');
            clienteSelect.addEventListener('change', function() {
                const clienteId = this.value;

                if (clienteId) {
                    // Fazendo a requisição para buscar ou criar o carrinho
                    fetch(`/api/buscar-ou-criar-carrinho/${clienteId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erro ao buscar o carrinho');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(data.carrinho);
                            if (data.error) {
                                alert(data.error);
                            } else {
                                // Exibe as informações do carrinho
                                displayCarrinhoInfo(data.carrinho);
                            }
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                            alert('Ocorreu um erro ao buscar o carrinho.');
                        });
                }
            });

            function displayCarrinhoInfo(carrinho) {
                //fazer um for ech em items aqui dentro
                const carrinhoInfoDiv = document.getElementById('tabela');
                carrinhoInfoDiv.innerHTML = `
                    <tr>
                    <td>${carrinho.items[0].produto.nome}<td>
                      <td>${carrinho.items[0].produto.categoria_id.id}<td>
                      <td class="quantidade">
						<input class="input-number" type="number" value=" ${carrinho.items[0].produto.qt_disponivel} " min="1">
					</td>
                    <td>${carrinho.items[0].produto.qt_disponivel}<td>
                    
                    <td>${carrinho.valor_total}<td>
                    </tr>
                   
                    
                `;
            }
        });
    </script>
{% endblock %}